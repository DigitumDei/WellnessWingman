<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:pageModels="clr-namespace:WellnessWingman.PageModels"
             x:Class="WellnessWingman.Pages.MealDetailPage"
             x:DataType="pageModels:MealDetailViewModel"
             Title="Meal Details">
    <ScrollView>
        <VerticalStackLayout Spacing="16" Padding="24">
            <Image Source="{Binding Meal.FullPath}"
                   Aspect="AspectFit"
                   HeightRequest="300"
                   AutomationProperties.AutomationId="MealDetailImage"
                   SemanticProperties.Description="Meal photo" />

            <Label Text="Description" Style="{StaticResource Title2}" />
            <Editor Text="{Binding EditableDescription}"
                    AutoSize="TextChanges"
                    Placeholder="Enter a description for your meal..."
                    AutomationProperties.AutomationId="MealDetailDescriptionEditor" />
            <Button Text="Save Description"
                    Command="{Binding SaveDescriptionCommand}"
                    Margin="0,8,0,0"
                    AutomationProperties.AutomationId="MealDetailSaveDescriptionButton" />

            <Label Text="{Binding Meal.LocalCapturedAt, StringFormat='Captured {0:MMM d, h:mm tt}'}" Style="{StaticResource Caption1}" />

            <Label Text="Analysis" Style="{StaticResource Title2}" Margin="0,16,0,0" />
            <Label Text="{Binding AnalysisText}" Style="{StaticResource Body1}"
                   AutomationProperties.AutomationId="MealDetailAnalysisLabel" />

            <Button Text="{Binding CorrectionToggleButtonText}"
                    Command="{Binding ToggleCorrectionCommand}"
                    Margin="0,16,0,0"
                    AutomationProperties.AutomationId="MealDetailCorrectionToggleButton" />

            <Border IsVisible="{Binding IsCorrectionMode}"
                    Padding="16">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="12" />
                </Border.StrokeShape>
                <VerticalStackLayout Spacing="12">
                    <Label Text="Add any details we missed so the analysis can be corrected."
                           Style="{StaticResource Caption1}" />
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                        <Label Grid.Column="0"
                               Text="{Binding RecordingButtonText}"
                               VerticalOptions="Center"
                               Style="{StaticResource Caption1}"
                               TextColor="{StaticResource Gray600}" />
                        <Button Grid.Column="1"
                                Text="{Binding RecordingButtonIcon}"
                                FontSize="24"
                                WidthRequest="56"
                                HeightRequest="56"
                                CornerRadius="28"
                                BackgroundColor="{Binding RecordingButtonColor}"
                                TextColor="White"
                                Command="{Binding ToggleRecordingCommand}"
                                IsEnabled="{Binding IsRecordingButtonEnabled}"
                                AutomationProperties.AutomationId="MealDetailVoiceButton"
                                SemanticProperties.Description="{Binding RecordingButtonText}" />
                    </Grid>

                    <StackLayout Orientation="Horizontal"
                                 Spacing="8"
                                 IsVisible="{Binding IsRecording}"
                                 HorizontalOptions="Start">
                        <Ellipse Fill="Red"
                                 WidthRequest="10"
                                 HeightRequest="10"
                                 VerticalOptions="Center" />
                        <Label Text="{Binding RecordingDuration, StringFormat='Recording... {0:mm\\:ss}'}"
                               Style="{StaticResource Body2}"
                               TextColor="Red"
                               VerticalOptions="Center" />
                    </StackLayout>

                    <ActivityIndicator IsRunning="{Binding IsTranscribing}"
                                       IsVisible="{Binding IsTranscribing}"
                                       Color="{StaticResource Primary}"
                                       HorizontalOptions="Start" />
                    <Label Text="Transcribing correction..."
                           IsVisible="{Binding IsTranscribing}"
                           Style="{StaticResource Caption1}"
                           TextColor="{StaticResource Gray700}"
                           HorizontalOptions="Start" />

                    <Editor Text="{Binding CorrectionText}"
                            Placeholder="Describe what's actually in the meal or what needs to change (or use the mic above)."
                            AutoSize="TextChanges"
                            MinimumHeightRequest="120"
                            AutomationProperties.AutomationId="MealDetailCorrectionEditor" />
                    <ActivityIndicator IsVisible="{Binding IsSubmittingCorrection}"
                                       IsRunning="{Binding IsSubmittingCorrection}"
                                       HorizontalOptions="Start"
                                       AutomationProperties.AutomationId="MealDetailActivityIndicator" />
                    <Button Text="Send correction"
                            Command="{Binding SubmitCorrectionCommand}"
                            AutomationProperties.AutomationId="MealDetailSubmitCorrectionButton" />
                </VerticalStackLayout>
            </Border>

            <Button Text="Delete"
                    Command="{Binding DeleteCommand}"
                    BackgroundColor="{StaticResource Error}"
                    TextColor="{StaticResource OnError}"
                    Margin="0,16,0,0"
                    AutomationProperties.AutomationId="MealDetailDeleteButton" />
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
