<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:pageModels="clr-namespace:WellnessWingman.PageModels"
             xmlns:models="clr-namespace:WellnessWingman.Models"
             x:Class="WellnessWingman.Pages.DailySummaryPage"
             x:DataType="pageModels:DailySummaryViewModel"
             Title="Daily Summary">
    <ScrollView>
        <VerticalStackLayout Spacing="16" Padding="24">
            <Label Text="Daily Summary"
                   Style="{StaticResource Headline}"
                   AutomationProperties.AutomationId="DailySummaryTitleLabel" />

            <ActivityIndicator IsRunning="{Binding IsBusy}"
                               IsVisible="{Binding IsBusy}"
                               AutomationProperties.AutomationId="DailySummaryActivityIndicator" />

            <Label Text="{Binding GeneratedAtText}"
                   Style="{StaticResource Caption1}" />

            <Label Text="{Binding ProcessingStatus, StringFormat='Status: {0}'}"
                   Style="{StaticResource Caption1}" />

            <Label Text="{Binding StatusMessage}"
                   Style="{StaticResource Body1}"
                   TextColor="{StaticResource Error}">
                <Label.Triggers>
                    <DataTrigger TargetType="Label"
                                Binding="{Binding StatusMessage}"
                                Value="">
                        <Setter Property="IsVisible" Value="False" />
                    </DataTrigger>
                </Label.Triggers>
            </Label>

            <Border StrokeThickness="1"
                    Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                    Padding="16"
                    StrokeShape="RoundRectangle 12,12,12,12">
                <VerticalStackLayout Spacing="16">
                    <Label Text="Nutrition Totals"
                           Style="{StaticResource Body2Strong}" />
                    
                    <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,*,*,*" RowSpacing="12">
                        <!-- Row 0: Macros -->
                        <VerticalStackLayout Grid.Row="0" Grid.Column="0">
                            <Label Text="{Binding Totals.Calories, StringFormat='{0:F0}'}" FontAttributes="Bold" HorizontalOptions="Center" FontSize="18"
                                   AutomationProperties.AutomationId="DailySummaryCaloriesLabel"/>
                            <Label Text="Cals" Style="{StaticResource Caption1}" HorizontalOptions="Center" />
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Row="0" Grid.Column="1">
                            <Label Text="{Binding Totals.Protein, StringFormat='{0:F0}g'}" FontAttributes="Bold" HorizontalOptions="Center" FontSize="18"/>
                            <Label Text="Prot" Style="{StaticResource Caption1}" HorizontalOptions="Center" />
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Row="0" Grid.Column="2">
                            <Label Text="{Binding Totals.Carbohydrates, StringFormat='{0:F0}g'}" FontAttributes="Bold" HorizontalOptions="Center" FontSize="18"/>
                            <Label Text="Carbs" Style="{StaticResource Caption1}" HorizontalOptions="Center" />
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Row="0" Grid.Column="3">
                            <Label Text="{Binding Totals.Fat, StringFormat='{0:F0}g'}" FontAttributes="Bold" HorizontalOptions="Center" FontSize="18"/>
                            <Label Text="Fat" Style="{StaticResource Caption1}" HorizontalOptions="Center" />
                        </VerticalStackLayout>

                        <!-- Row 1: Micros -->
                        <Grid Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="4" ColumnDefinitions="*,*,*">
                            <VerticalStackLayout Grid.Column="0" HorizontalOptions="Center">
                                <Label Text="{Binding Totals.Fiber, StringFormat='{0:F0}g'}" FontAttributes="Bold" HorizontalOptions="Center" FontSize="16"/>
                                <Label Text="Fiber" Style="{StaticResource Caption1}" HorizontalOptions="Center" />
                            </VerticalStackLayout>
                            <VerticalStackLayout Grid.Column="1" HorizontalOptions="Center">
                                <Label Text="{Binding Totals.Sugar, StringFormat='{0:F0}g'}" FontAttributes="Bold" HorizontalOptions="Center" FontSize="16"/>
                                <Label Text="Sugar" Style="{StaticResource Caption1}" HorizontalOptions="Center" />
                            </VerticalStackLayout>
                            <VerticalStackLayout Grid.Column="2" HorizontalOptions="Center">
                                <Label Text="{Binding Totals.Sodium, StringFormat='{0:F0}mg'}" FontAttributes="Bold" HorizontalOptions="Center" FontSize="16"/>
                                <Label Text="Sodium" Style="{StaticResource Caption1}" HorizontalOptions="Center" />
                            </VerticalStackLayout>
                        </Grid>
                    </Grid>
                </VerticalStackLayout>
            </Border>

            <Border StrokeThickness="1"
                    Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                    Padding="16"
                    StrokeShape="RoundRectangle 12,12,12,12">
                <VerticalStackLayout Spacing="8">
                    <Label Text="Balance"
                           Style="{StaticResource Body2Strong}" />
                    <Label Text="{Binding BalanceOverall}"
                           Style="{StaticResource Body1}" />
                    <Label Text="{Binding BalanceMacro}"
                           Style="{StaticResource Body1}" />
                    <Label Text="{Binding BalanceTiming}"
                           Style="{StaticResource Body1}" />
                    <Label Text="{Binding BalanceVariety}"
                           Style="{StaticResource Body1}" />
                </VerticalStackLayout>
            </Border>

            <Label Text="Insights"
                   Style="{StaticResource Body2Strong}" />
            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Insights}"
                                 Spacing="8"
                                 AutomationProperties.AutomationId="DailySummaryInsightsList">
                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="x:String">
                        <Label Text="{Binding .}"
                               Style="{StaticResource Body1}"
                               LineBreakMode="WordWrap" />
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
                <BindableLayout.EmptyView>
                    <Label Text="No insights yet."
                           Style="{StaticResource Caption1}" />
                </BindableLayout.EmptyView>
            </VerticalStackLayout>

            <Label Text="Recommendations"
                   Style="{StaticResource Body2Strong}" />
            <VerticalStackLayout BindableLayout.ItemsSource="{Binding Recommendations}"
                                 Spacing="8"
                                 AutomationProperties.AutomationId="DailySummaryRecommendationsList">
                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="x:String">
                        <Label Text="{Binding .}"
                               Style="{StaticResource Body1}"
                               LineBreakMode="WordWrap" />
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
                <BindableLayout.EmptyView>
                    <Label Text="No recommendations yet."
                           Style="{StaticResource Caption1}" />
                </BindableLayout.EmptyView>
            </VerticalStackLayout>

            <Label Text="Entries Covered"
                   Style="{StaticResource Body2Strong}" />
            <VerticalStackLayout BindableLayout.ItemsSource="{Binding EntriesIncluded}"
                                 Spacing="8">
                <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="models:DailySummaryEntryReference">
                        <VerticalStackLayout Spacing="4">
                            <Label Text="{Binding EntryType}"
                                   Style="{StaticResource Caption1}" />
                            <Label Text="{Binding CapturedAt, StringFormat='Captured {0:MMM d, h:mm tt}'}"
                                   Style="{StaticResource Caption1}" />
                            <Label Text="{Binding Summary}"
                                   Style="{StaticResource Body1}" />
                        </VerticalStackLayout>
                    </DataTemplate>
                </BindableLayout.ItemTemplate>
                <BindableLayout.EmptyView>
                    <Label Text="No entries were summarized."
                           Style="{StaticResource Caption1}" />
                </BindableLayout.EmptyView>
            </VerticalStackLayout>

            <Button Text="Regenerate Summary"
                    Command="{Binding RegenerateCommand}"
                    IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}"
                    AutomationProperties.AutomationId="DailySummaryRegenerateButton" />
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
